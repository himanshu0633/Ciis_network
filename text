import React, { useEffect, useState, useMemo } from "react";
import {
  Box,
  Typography,
  Drawer,
  Chip,
  Stack,
  Divider,
  Table,
  TableHead,
  TableRow,
  TableCell,
  TableBody,
  Dialog,
  DialogTitle,
  DialogContent,
  DialogActions,
  Button,
  FormControl,
  InputLabel,
  Select,
  MenuItem,
  TextField,
  Tooltip,
  CircularProgress,
  Paper,
  IconButton,
} from "@mui/material";
import { DataGrid } from "@mui/x-data-grid";
import dayjs from "dayjs";
import axiosInstance from "../../utils/axiosConfig";
import { toast } from "react-toastify";
import PictureAsPdfIcon from "@mui/icons-material/PictureAsPdf";
import ChatIcon from "@mui/icons-material/Chat";
import EditIcon from "@mui/icons-material/Edit";

const STATUS_OPTIONS = ["Pending", "In Progress", "Completed", "Rejected"];

const statusColor = (s) =>
  s === "Pending"
    ? "warning"
    : s === "In Progress"
    ? "primary"
    : s === "Completed"
    ? "success"
    : "error";

const EmployeeProjects = () => {
  const [projects, setProjects] = useState([]);
  const [loading, setLoading] = useState(false);
  const [drawerOpen, setDrawerOpen] = useState(false);
  const [selectedProject, setSelectedProject] = useState(null);

  // Dialogs
  const [statusDialog, setStatusDialog] = useState(false);
  const [remarksDialog, setRemarksDialog] = useState(false);
  const [reassignDialog, setReassignDialog] = useState(false);

  // Inputs
  const [selectedTask, setSelectedTask] = useState(null);
  const [newStatus, setNewStatus] = useState("Pending");
  const [newRemark, setNewRemark] = useState("");
  const [reassignUser, setReassignUser] = useState("");

  const [updating, setUpdating] = useState(false);

  const me = useMemo(() => {
    try {
      const raw = localStorage.getItem("user");
      return raw ? JSON.parse(raw) : null;
    } catch {
      return null;
    }
  }, []);

  // 游릭 FETCH PROJECTS
  const fetchProjects = async () => {
    setLoading(true);
    try {
      const { data } = await axiosInstance.get("/projects?page=1&limit=100");
      const list = Array.isArray(data?.items) ? data.items : [];
      const cleaned = list.map((p) => ({
        _id: p?._id,
        projectName: p?.projectName || "Untitled",
        status: p?.status || "Pending",
        users: Array.isArray(p?.users) ? p.users : [],
        tasks: Array.isArray(p?.tasks) ? p.tasks : [],
        startDate: p?.startDate || null,
        endDate: p?.endDate || null,
      }));
      setProjects(cleaned);
    } catch (err) {
      toast.error("Failed to load projects");
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    fetchProjects();
  }, []);

  const openDrawer = (project) => {
    setSelectedProject(project);
    setDrawerOpen(true);
  };

  const isMyTask = (task) => {
    const myId = me?._id || me?.id;
    const assignedId = task?.assignedTo?._id || task?.assignedTo;
    return String(myId) === String(assignedId);
  };

  // 游릭 STATUS UPDATE
  const openStatusUpdate = (task) => {
    setSelectedTask(task);
    setNewStatus(task?.status || "Pending");
    setStatusDialog(true);
  };

  const handleUpdateStatus = async () => {
    if (!selectedProject || !selectedTask) return;
    try {
      setUpdating(true);
      const res = await axiosInstance.patch(
        `/projects/${selectedProject._id}/tasks/${selectedTask._id}`,
        { status: newStatus }
      );
      setSelectedProject(res.data);
      fetchProjects();
      toast.success("Task status updated!");
      setStatusDialog(false);
    } catch {
      toast.error("Failed to update status");
    } finally {
      setUpdating(false);
    }
  };

  // 游릭 ADD REMARK
  const openRemarkDialog = (task) => {
    setSelectedTask(task);
    setNewRemark("");
    setRemarksDialog(true);
  };

  const handleAddRemark = async () => {
    if (!newRemark.trim()) return toast.error("Enter a remark");
    try {
      setUpdating(true);
      const res = await axiosInstance.post(
        `/projects/${selectedProject._id}/tasks/${selectedTask._id}/remarks`,
        { text: newRemark }
      );
      setSelectedProject(res.data);
      toast.success("Remark added!");
      setRemarksDialog(false);
    } catch {
      toast.error("Failed to add remark");
    } finally {
      setUpdating(false);
    }
  };

  // 游릭 REASSIGN TASK
  const openReassignDialog = (task) => {
    setSelectedTask(task);
    setReassignUser("");
    setReassignDialog(true);
  };

  const handleReassignTask = async () => {
    if (!selectedProject || !selectedTask || !reassignUser)
      return toast.error("Select a user to reassign");

    try {
      setUpdating(true);
      const res = await axiosInstance.patch(
        `/projects/${selectedProject._id}/tasks/${selectedTask._id}`,
        { assignedTo: reassignUser }
      );
      setSelectedProject(res.data);
      fetchProjects();
      toast.success("Task reassigned successfully!");
      setReassignDialog(false);
    } catch (err) {
      console.error("Reassign error:", err);
      toast.error("Failed to reassign task");
    } finally {
      setUpdating(false);
    }
  };

  const openPDF = (path) => {
    if (!path) return toast.error("No PDF file found!");
    window.open(`http://localhost:3000/${path}`, "_blank");
  };

  // 游릭 DATAGRID
  const columns = [
    {
      field: "projectName",
      headerName: "Project",
      flex: 1.3,
      renderCell: (p) => p.row?.projectName || "Untitled",
    },
    {
      field: "status",
      headerName: "Status",
      width: 130,
      renderCell: (params) => (
        <Chip
          label={params.row?.status || "Pending"}
          color={statusColor(params.row?.status || "Pending")}
          size="small"
        />
      ),
    },
    {
      field: "tasks",
      headerName: "Tasks",
      width: 90,
      valueGetter: (params) =>
        Array.isArray(params?.row?.tasks) ? params.row.tasks.length : 0,
    },
    {
      field: "startDate",
      headerName: "Start Date",
      flex: 1,
      valueGetter: (params) =>
        params?.row?.startDate
          ? dayjs(params.row.startDate).format("DD/MM/YYYY")
          : "-",
    },
    {
      field: "endDate",
      headerName: "End Date",
      flex: 1,
      valueGetter: (params) =>
        params?.row?.endDate
          ? dayjs(params.row.endDate).format("DD/MM/YYYY")
          : "-",
    },
  ];

  return (
    <Box sx={{ p: 3 }}>
      <Typography variant="h4" fontWeight={700} mb={2}>
        My Projects
      </Typography>

      <Paper sx={{ height: 500, borderRadius: 3 }}>
        <DataGrid
          rows={projects}
          getRowId={(r) => r._id}
          columns={columns}
          loading={loading}
          onRowClick={(params) => openDrawer(params.row)}
        />
      </Paper>

      {/* 游릭 DRAWER */}
      <Drawer
        anchor="right"
        open={drawerOpen}
        onClose={() => setDrawerOpen(false)}
        PaperProps={{ sx: { width: 480, p: 3 } }}
      >
        <Typography variant="h6" fontWeight={700} mb={1}>
          {selectedProject?.projectName || "Project Details"}
        </Typography>

        <Stack direction="row" spacing={1} mb={2}>
          <Chip
            label={selectedProject?.status || "Pending"}
            color={statusColor(selectedProject?.status || "Pending")}
          />
        </Stack>

        <Typography variant="subtitle2" mb={1}>
          Members:
        </Typography>
        <Stack direction="row" flexWrap="wrap" gap={1} mb={2}>
          {(selectedProject?.users || []).map((u) => (
            <Chip key={u._id} label={u?.name || "User"} size="small" />
          ))}
        </Stack>

        <Divider sx={{ my: 2 }} />
        <Typography variant="subtitle1" fontWeight={600} mb={1}>
          Tasks
        </Typography>

        <Table size="small">
          <TableHead>
            <TableRow>
              <TableCell>Title</TableCell>
              <TableCell>Status</TableCell>
              <TableCell width={180}>Actions</TableCell>
            </TableRow>
          </TableHead>
          <TableBody>
            {(selectedProject?.tasks || []).map((t) => (
              <TableRow key={t._id} hover>
                <TableCell>{t?.taskName || "Untitled"}</TableCell>
                <TableCell>
                  <Chip
                    label={t?.status || "Pending"}
                    color={statusColor(t?.status || "Pending")}
                    size="small"
                    onClick={() => isMyTask(t) && openStatusUpdate(t)}
                    sx={{
                      cursor: isMyTask(t) ? "pointer" : "not-allowed",
                    }}
                  />
                </TableCell>
                <TableCell>
                  {t?.pdfFile && (
                    <Tooltip title="View PDF">
                      <IconButton onClick={() => openPDF(t.pdfFile.path)}>
                        <PictureAsPdfIcon color="error" />
                      </IconButton>
                    </Tooltip>
                  )}
                  <Tooltip title="Add Remark">
                    <IconButton onClick={() => openRemarkDialog(t)}>
                      <ChatIcon color="primary" />
                    </IconButton>
                  </Tooltip>
                  <Tooltip title="Reassign Task">
                    <IconButton
                      onClick={() => openReassignDialog(t)}
                      disabled={!isMyTask(t)}
                    >
                      <EditIcon
                        color={isMyTask(t) ? "secondary" : "disabled"}
                      />
                    </IconButton>
                  </Tooltip>
                </TableCell>
              </TableRow>
            ))}
          </TableBody>
        </Table>
      </Drawer>

      {/* 游릭 STATUS DIALOG */}
      <Dialog open={statusDialog} onClose={() => setStatusDialog(false)}>
        <DialogTitle>Update Task Status</DialogTitle>
        <DialogContent sx={{ minWidth: 320 }}>
          <FormControl fullWidth sx={{ mt: 1 }}>
            <InputLabel>Status</InputLabel>
            <Select
              value={newStatus}
              label="Status"
              onChange={(e) => setNewStatus(e.target.value)}
            >
              {STATUS_OPTIONS.map((s) => (
                <MenuItem key={s} value={s}>
                  {s}
                </MenuItem>
              ))}
            </Select>
          </FormControl>
        </DialogContent>
        <DialogActions>
          <Button onClick={() => setStatusDialog(false)}>Cancel</Button>
          <Button
            variant="contained"
            onClick={handleUpdateStatus}
            disabled={updating}
            startIcon={updating && <CircularProgress size={18} />}
          >
            {updating ? "Updating..." : "Update"}
          </Button>
        </DialogActions>
      </Dialog>

      {/* 游릭 REMARK DIALOG */}
      <Dialog open={remarksDialog} onClose={() => setRemarksDialog(false)}>
        <DialogTitle>Add Remark</DialogTitle>
        <DialogContent sx={{ minWidth: 360 }}>
          <TextField
            label="Remark"
            fullWidth
            multiline
            rows={3}
            value={newRemark}
            onChange={(e) => setNewRemark(e.target.value)}
            sx={{ mt: 1 }}
          />
        </DialogContent>
        <DialogActions>
          <Button onClick={() => setRemarksDialog(false)}>Cancel</Button>
          <Button
            variant="contained"
            onClick={handleAddRemark}
            disabled={updating}
          >
            {updating ? "Saving..." : "Save"}
          </Button>
        </DialogActions>
      </Dialog>

      {/* 游릭 REASSIGN DIALOG */}
      <Dialog open={reassignDialog} onClose={() => setReassignDialog(false)}>
        <DialogTitle>Reassign Task</DialogTitle>
        <DialogContent sx={{ minWidth: 360 }}>
          <FormControl fullWidth sx={{ mt: 2 }}>
            <InputLabel>Select User</InputLabel>
            <Select
              value={reassignUser}
              label="Select User"
              onChange={(e) => setReassignUser(e.target.value)}
            >
              {(selectedProject?.users || []).map((u) => (
                <MenuItem key={u._id} value={u._id}>
                  {u.name}
                </MenuItem>
              ))}
            </Select>
          </FormControl>
        </DialogContent>
        <DialogActions>
          <Button onClick={() => setReassignDialog(false)}>Cancel</Button>
          <Button
            variant="contained"
            onClick={handleReassignTask}
            disabled={updating}
            startIcon={updating && <CircularProgress size={18} />}
          >
            {updating ? "Reassigning..." : "Reassign"}
          </Button>
        </DialogActions>
      </Dialog>
    </Box>
  );
};

export default EmployeeProjects;
